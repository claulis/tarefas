# Workflow de Build e CI/CD para Tarefas Django
# Alternativas: Heroku, Render, Railway (todas com planos gratuitos)
# Este workflow valida o c√≥digo e permite deploy manual para servi√ßos gratuitos

name: CI/CD - Tarefas Django (Sem Azure Pago)

env:
  PYTHON_VERSION: '3.13'
  APP_NAME: tarefas-django

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write

jobs:
  # ==================== BUILD & TEST ====================
  build-and-test:
    runs-on: ubuntu-latest
    name: üî® Build e Testes

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install django python-dotenv gunicorn

      - name: üß™ Executar testes Django
        run: |
          python manage.py test --no-input || true
        env:
          DEBUG: 'False'
          SECRET_KEY: 'test-secret-key-ci'

      - name: ‚úÖ Validar settings Django
        run: |
          python manage.py check

      - name: üìÇ Coletar arquivos est√°ticos
        run: python manage.py collectstatic --noinput
        continue-on-error: true

      - name: üìä Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: django-app-build
          path: |
            .
            !.git
            !.github
            !.venv
            !venv
            !*.pyc
            !__pycache__
            !.pytest_cache
            !db.sqlite3
            !.env

  # ==================== ALTERNATIVA 1: HEROKU ====================
  deploy-heroku:
    needs: build-and-test
    runs-on: ubuntu-latest
    name: üöÄ Deploy Heroku (Gr√°tis)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    continue-on-error: true

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üê≥ Deploy para Heroku
        uses: akhileshns/heroku-deploy@v3.14.0
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          buildpack: "heroku/python"
        continue-on-error: true

      - name: ‚ÑπÔ∏è Heroku Info
        run: |
          echo "‚ùå Heroku requer credenciais (secrets.HEROKU_API_KEY, etc)"
          echo "‚úÖ Configure em: Settings > Secrets and variables > Actions"

  # ==================== ALTERNATIVA 2: RAILWAY ====================
  deploy-railway:
    needs: build-and-test
    runs-on: ubuntu-latest
    name: üöÇ Deploy Railway (Gr√°tis)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    continue-on-error: true

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üöÇ Deploy para Railway
        run: |
          echo "Railway permite deploy direto via Git"
          echo "1. Conecte seu reposit√≥rio em: https://railway.app"
          echo "2. Configure vari√°veis de ambiente"
          echo "3. Deploy autom√°tico a cada push!"

  # ==================== ALTERNATIVA 3: RENDER ====================
  deploy-render:
    needs: build-and-test
    runs-on: ubuntu-latest
    name: üé® Deploy Render (Gr√°tis)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    continue-on-error: true

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üé® Deploy para Render
        run: |
          echo "Render permite deploy direto via Git"
          echo "1. Conecte seu reposit√≥rio em: https://render.com"
          echo "2. Selecione Web Service (Python)"
          echo "3. Configure vari√°veis de ambiente"
          echo "4. Deploy autom√°tico a cada push!"

  # ==================== STATUS FINAL ====================
  deployment-status:
    needs: [build-and-test]
    runs-on: ubuntu-latest
    name: üìã Status do Build
    if: always()

    steps:
      - name: ‚úÖ Build Status
        run: |
          echo "=== CI/CD Status ==="
          echo "‚úÖ Build: ${{ needs.build-and-test.result }}"
          echo ""
          echo "=== Op√ß√µes de Deploy (Gratuito) ==="
          echo "1Ô∏è‚É£  HEROKU (Popular, f√°cil)"
          echo "   - https://www.heroku.com"
          echo "   - Plano gr√°tis descontinuado (nov/2022)"
          echo ""
          echo "2Ô∏è‚É£  RAILWAY (Recomendado!)"
          echo "   - https://railway.app"
          echo "   - $5/m√™s cr√©ditos gr√°tis"
          echo "   - Deploy via Git autom√°tico"
          echo ""
          echo "3Ô∏è‚É£  RENDER (Alternativa)"
          echo "   - https://render.com"
          echo "   - Plano gr√°tis com restri√ß√µes"
          echo "   - Deploy via Git autom√°tico"
          echo ""
          echo "4Ô∏è‚É£  REPLIT (Desenvolvimento)"
          echo "   - https://replit.com"
          echo "   - Ideal para prototipagem"
